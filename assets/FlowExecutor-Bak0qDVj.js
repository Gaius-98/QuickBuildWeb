var d=Object.defineProperty;var h=(r,t,e)=>t in r?d(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var n=(r,t,e)=>(h(r,typeof t!="symbol"?t+"":t,e),e);import{_ as l}from"./LowCodeFormId.vue_vue_type_script_setup_true_lang-DEM9RlQ5.js";import{c}from"./iconfont-DbxD-LdR.js";import{a2 as f,h as w}from"./.pnpm-CfU0UuIO.js";class D{constructor(t){n(this,"state",{});n(this,"InternalMapping",new Map);n(this,"rawData");n(this,"flowNodeList");this.rawData=t,this.flowNodeList=[],this.handleData(),this.InternalMapping=new Map([["func-node",this.executeFunction],["request-node",this.requestData],["link-node",this.onOpenLink],["modal-node",this.onOpenModal]])}setModalFormData(t){this.state.modalFormData=t}handleData(){var e;const t=this.findFirstNode();return this.findLastNode(),(e=this.flowNodeList)==null||e.push(t),this.recPushNode(),this.flowNodeList}getFlowList(){return this.flowNodeList}getState(){return this.state}recPushNode(){var e,o;const t=(e=this.flowNodeList)==null?void 0:e.at(-1);if(!this.isLast(t)){const a=this.findNextNode(t);return(o=this.flowNodeList)==null||o.push(a),this.recPushNode()}}findFirstNode(){if(!this.rawData)throw"The workflow has no data";const t=this.rawData.nodes.find(e=>this.isFirst(e));if(!t)throw"The workflow does not have a start node";return t}findNextNode(t){const e=this.rawData.edges.find(s=>s.sourceNodeId==t.id);if(!e)throw"The next edge was not found in the workflow data, please check the data!";const o=e.targetNodeId,a=this.rawData.nodes.find(s=>s.id==o);if(!a)throw"The next node was not found in the workflow data, please check the data!";return a}findLastNode(){var e;if(!((e=this.rawData)==null?void 0:e.nodes.some(o=>this.isLast(o))))throw"The workflow does not have a last node"}isFirst(t){return t.properties.nodeType=="start-node"}isLast(t){return t.properties.nodeType=="end-node"}onOpenModal(t){const{size:e,formId:o}=t.properties.extraData;this.state.modalFormData=this.state.modalFormData?this.state.modalFormData:{};const a={small:"600px",middle:"1200px",large:"1800px"};return new Promise((s,i)=>{f.confirm({content:w(l,{id:o,formData:this.state.modalFormData}),icon:null,title:"表单",width:a[e],onCancel:()=>{i()},onOk:()=>{s(this.state.modalFormData)}})})}onOpenLink(t){const{url:e,openType:o}=t.properties.extraData;window.open(e,o)}async requestData(t){const e=new Promise((a,s)=>{c.getProxyData({...t.properties.extraData,state:this.state}).then(i=>{a(i.data)})});let o;try{o=await e}catch(a){console.error(a)}this.state.requestData=o}executeFunction(t){const{code:e}=t.properties.extraData,o=new Function(`return  ()=>{${e}}`),a=this;try{return o.call(a)()}catch(s){console.error(s)}}async run(){var t;if(this.flowNodeList)try{for(let e=1;e<this.flowNodeList.length-1;e++){const o=this.flowNodeList[e],a=o.properties.nodeType;this.InternalMapping.get(a)&&await((t=this.InternalMapping.get(a))==null?void 0:t.call(this,o))}}catch(e){return e}}}export{D as F};
