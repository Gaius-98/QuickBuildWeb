import{c as j}from"./iconfont-fCxWMeQn.js";import{k as A,r as i,m as R,t as S,n as G,d as B,s as H,p as V,b as W,q as T,o as b,e as U,w as F,v as $,x as L,c as q,y as Q,z as J,A as K,u as f,B as N,D as E,E as P,F as X,G as M,H as Y,g as Z,i as tt,I as et}from"./.pnpm-DVFE1QU-.js";import{c as z}from"./componentsSchema-LhIlCAWr.js";import{D as at,a as st}from"./DynamicLoader-Cph9-XpQ.js";import{_ as O}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ot=A("dgDesign",()=>{const r=i({}),o=i([]),n=i({});i("");const l=t=>{o.value.push(t)},_=t=>{const{id:s}=t,e=o.value.findIndex(u=>u.id===s);e!==-1&&o.value.splice(e,1)},d=t=>{o.value=t},c=t=>{const s=z.findIndex(u=>u.name===t);if(s===-1)throw new Error("组件不存在");const e=R(z[s]);return e.id=new Date().getTime().toString(),e},h=t=>{n.value.id!==t.id&&(n.value=t,window.parent.postMessage({type:"select",data:S(t)},window.location.origin))},D=t=>{const{id:s}=t,e=o.value.findIndex(u=>u.id===s);e!==-1&&o.value.splice(e,1,t)},I=t=>{window.parent.postMessage({type:"update-item",data:S(t)},window.location.origin)},x=t=>new at(p.value).processObject(t),w=()=>{a().then(t=>{window.parent.postMessage({type:"save",data:{list:S(o.value),img:t}},window.location.origin)})},g=i({datasets:[],vars:[{name:"test",type:"string",defaultValue:"这是一段测试文本"}]}),C=t=>{g.value=t,v()},p=i({}),m=t=>{const s={},e=(u,y)=>{switch(u){case"string":return y;case"number":return Number(y);case"boolean":return!!y;case"array":case"object":return JSON.parse(y);default:return y}};return t.reduce((u,y)=>(u[y.name]=e(y.type,y.defaultValue),u),s),s},v=()=>{p.value=m(g.value.vars)},a=async()=>{const t=document.querySelector(".dg-design-container");return(await G(t)).toDataURL("image/png")};return{dashboardData:r,add:l,remove:_,dgList:o,initDgItem:c,selectItem:h,curComp:n,updateItem:D,transformProps:x,updateVariables:v,setVarPools:C,updateDgItem:I,sendDgList:w,createPreviewImg:a,init:d}}),nt=12,rt=8,ct=B({__name:"StandalonePage",setup(r){const o=ot(),{dgList:n}=H(o),{initDgItem:l,add:_,selectItem:d,updateItem:c,transformProps:h,setVarPools:D,updateDgItem:I,sendDgList:x,init:w}=o,g=i(!1),C=i(),p=i(0),m=a=>{const t=a.dataTransfer.getData("material-type");let s;t=="custom"?s={name:a.dataTransfer.getData("material"),id:new Date().getTime().toString(),label:"自定义组件",icon:"",type:"custom",component:a.dataTransfer.getData("material"),props:{},style:{},rowStart:1,colStart:1,rowSpan:5,colSpan:2}:s=l(a.dataTransfer.getData("material"));const e=a.x/(p.value/nt),u=a.y/rt;s.colStart=Math.floor(e),s.rowStart=Math.floor(u),_(s)},v=i({});return window.addEventListener("message",a=>{a.data.type==="refresh"?c(a.data.data):a.data.type==="add-custom-comp"?new st([a.data.data]).load().then(s=>{Object.keys(s).forEach(e=>{v.value[e]=s[e]})}):a.data.type==="refresh-var"?D(a.data.data):a.data.type==="get-dg"?x():a.data.type==="refresh-all"?w(a.data.data):a.data.type==="preview"&&(g.value=!0)}),V(()=>{p.value=C.value.clientWidth}),(a,t)=>{const s=W("grid-layout");return b(),T("div",{class:"container dg-design-container",ref_key:"container",ref:C,onDragover:t[0]||(t[0]=E(()=>{},["prevent","stop"])),onDrop:E(m,["stop"])},[U(s,{list:f(n),class:N(["layout",{readonly:g.value}]),readonly:g.value,"onItem:click":f(d),"onItem:change":f(I)},{"layout-item":F(({item:e})=>[$("div",{class:"comp-container",style:L(e.style)},[e.type&&e.type==="custom"?(b(),q(Q(v.value[e.component]),J(K({key:0},f(h)(e.props))),null,16)):(b(),q(Q(e.component),{key:1,"style-config":e.style,attrs:f(h)(e.props)},null,8,["style-config","attrs"]))],4)]),_:1},8,["list","class","readonly","onItem:click","onItem:change"])],544)}}}),it=O(ct,[["__scopeId","data-v-6302b6f0"]]),lt=B({__name:"QBChart",props:{attrs:{default:()=>({dataset:"",dimension:[],target:[]})},styleConfig:{default:()=>({})}},setup(r){const o=r,{attrs:n,styleConfig:l}=P(o),_=i(!0),d=i();let c;const h=i(0),D=i(""),I=i([{title:"title1",value:100},{title:"title2",value:200},{title:"title3",value:300}]),x=async()=>{D.value=n.value.dataset;const{data:p,code:m,msg:v}=await j.getPreviewByDatasetId(D.value);m==200?I.value=p:I.value=[]},w=()=>{const{dimension:p,target:m}=n.value,v=S(l.value.option),a=S(l.value.series),t=[];return m.forEach(s=>{t.push(R(a))}),v.series=t,{...v,dataset:{source:S(I.value)||[],dimensions:[...p,...m]}}},g=()=>{n.value.dataset&&D.value!=n.value.dataset?x().then(()=>{c?(c.clear(),c.setOption(w())):d.value&&(c=M(d.value),c.setOption(w()))}):c?(c.clear(),c.setOption(w())):d.value&&(c=M(d.value),c.setOption(w())),_.value=!1},C=new ResizeObserver(p=>{h.value&&clearTimeout(h.value),h.value=window.setTimeout(()=>{try{c.resize()}catch(m){console.warn(`chart重新设置大小失败,失败原因：${m}`)}},100)});return V(()=>{g(),setTimeout(()=>{C.observe(d.value)},100)}),X(()=>[o.styleConfig],()=>{g()},{deep:!0}),(p,m)=>(b(),T("div",{ref_key:"QBChart",ref:d,class:"qb-chart"},null,512))}}),dt=O(lt,[["__scopeId","data-v-dd5ee5c9"]]),ut={class:"qb-iframe"},pt=["src"],mt=B({__name:"QBIframe",props:{attrs:{default:()=>({src:""})},preview:{type:Boolean,default:!1}},setup(r){const o=r,{attrs:n,preview:l}=P(o);return(_,d)=>(b(),T("div",ut,[$("iframe",{class:N(f(l)?"":"no-effect"),src:f(n).src,style:{width:"100%",height:"100%",border:"none"}},null,10,pt)]))}}),ft=O(mt,[["__scopeId","data-v-67323949"]]),gt=["src"],vt=B({__name:"QBImage",props:{attrs:{default:()=>({src:""})},styleConfig:{default:()=>({})}},setup(r){const o=r,{attrs:n,styleConfig:l}=P(o);return(_,d)=>(b(),T("img",{class:"qb-image",style:L([{width:"100%",height:"100%"},f(l)]),src:f(n).src},null,12,gt))}}),yt=O(vt,[["__scopeId","data-v-3b56b274"]]),_t=B({__name:"QBText",props:{attrs:{default:()=>({text:""})},styleConfig:{default:()=>({})}},setup(r){const o=r,{attrs:n}=P(o);return(l,_)=>(b(),T("div",{class:"qb-text",style:L(l.styleConfig)},Y(f(n).text),5))}}),ht=O(_t,[["__scopeId","data-v-ad3a33fa"]]),wt=r=>{r.component("qb-chart",dt),r.component("qb-iframe",ft),r.component("qb-image",yt),r.component("qb-text",ht)},k=Z(it);k.use(tt());k.use(wt);k.component("GridLayout",et);k.mount("#standalone-app");
