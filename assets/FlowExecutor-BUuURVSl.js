var h=Object.defineProperty;var l=(o,t,e)=>t in o?h(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var n=(o,t,e)=>(l(o,typeof t!="symbol"?t+"":t,e),e);import{r as i,c}from"./main-ofbBpIGf.js";import{_ as u}from"./LowCodeFormId.vue_vue_type_script_setup_true_lang-OYxhfWSC.js";import{ah as p,n as f}from"./.pnpm-Df0qOu1O.js";const g={getList:o=>i({method:"get",url:"table/list",params:o}),getDetail:o=>i({method:"get",url:"table/detail",params:{id:o}}),remove:o=>i({method:"get",url:"table/remove",params:{id:o}}),add:o=>i({method:"post",url:"table/add",data:o}),update:o=>i({method:"post",url:"table/update",data:o})};class L{constructor(t){n(this,"state",{});n(this,"InternalMapping",new Map);n(this,"rawData");n(this,"flowNodeList");this.rawData=t,this.flowNodeList=[],this.handleData(),this.InternalMapping=new Map([["func-node",this.executeFunction],["request-node",this.requestData],["link-node",this.onOpenLink],["modal-node",this.onOpenModal]])}setModalFormData(t){this.state.modalFormData=t}handleData(){var e;const t=this.findFirstNode();return this.findLastNode(),(e=this.flowNodeList)==null||e.push(t),this.recPushNode(),this.flowNodeList}getFlowList(){return this.flowNodeList}getState(){return this.state}recPushNode(){var e,a;const t=(e=this.flowNodeList)==null?void 0:e.at(-1);if(!this.isLast(t)){const s=this.findNextNode(t);return(a=this.flowNodeList)==null||a.push(s),this.recPushNode()}}findFirstNode(){if(!this.rawData)throw"The workflow has no data";const t=this.rawData.nodes.find(e=>this.isFirst(e));if(!t)throw"The workflow does not have a start node";return t}findNextNode(t){const e=this.rawData.edges.find(r=>r.sourceNodeId==t.id);if(!e)throw"The next edge was not found in the workflow data, please check the data!";const a=e.targetNodeId,s=this.rawData.nodes.find(r=>r.id==a);if(!s)throw"The next node was not found in the workflow data, please check the data!";return s}findLastNode(){var e;if(!((e=this.rawData)==null?void 0:e.nodes.some(a=>this.isLast(a))))throw"The workflow does not have a last node"}isFirst(t){return t.properties.nodeType=="start-node"}isLast(t){return t.properties.nodeType=="end-node"}onOpenModal(t){const{size:e,formId:a}=t.properties.extraData;this.state.modalFormData=this.state.modalFormData?this.state.modalFormData:{};const s={small:"600px",middle:"1200px",large:"1800px"};return new Promise((r,d)=>{p.confirm({content:f(u,{id:a,formData:this.state.modalFormData}),icon:null,title:"表单",width:s[e],onCancel:()=>{d()},onOk:()=>{r(this.state.modalFormData)}})})}onOpenLink(t){const{url:e,openType:a}=t.properties.extraData;window.open(e,a)}async requestData(t){const e=new Promise((s,r)=>{c.getProxyData({...t.properties.extraData,state:this.state}).then(d=>{s(d.data)})});let a;try{a=await e}catch(s){console.error(s)}this.state.requestData=a}executeFunction(t){const{code:e}=t.properties.extraData,a=new Function(`return  ()=>{${e}}`),s=this;try{return a.call(s)()}catch(r){console.error(r)}}async run(){var t;if(this.flowNodeList)try{for(let e=1;e<this.flowNodeList.length-1;e++){const a=this.flowNodeList[e],s=a.properties.nodeType;this.InternalMapping.get(s)&&await((t=this.InternalMapping.get(s))==null?void 0:t.call(this,a))}}catch(e){return e}}}export{L as F,g as a};
