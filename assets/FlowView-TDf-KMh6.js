var W=Object.defineProperty;var X=(m,t,o)=>t in m?W(m,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):m[t]=o;var b=(m,t,o)=>(X(m,typeof t!="symbol"?t+"":t,o),o);import{_ as Y}from"./CodeEditor.vue_vue_type_script_setup_true_name_EvCode_lang-C_0c7hk9.js";import{_ as Q}from"./EventFlow-BqO0HQcY.js";import{c as Z}from"./index-Fwjej_wc.js";import{g as q,t as ee,x as te,v as ae,D as M,o as v,h as F,w as r,V as h,y as k,l as n,i as $,bl as E,bm as oe,B as w,n as P,W as z,N as j,Y as K,a2 as ne,R as se,r as f,F as C,H as le,J as re,X as de,a3 as ue,a4 as ie,ai as pe,a$ as ce,a_ as me,$ as _e}from"./.pnpm-BrZBTk42.js";import{_ as fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{_ as ve}from"./LowCodeFormId.vue_vue_type_script_setup_true_lang-BjbKCXT0.js";import"./LowCodeForm.vue_vue_type_script_setup_true_lang-DKbmLR5J.js";const xe={key:2,style:{display:"flex"}},we=q({__name:"EditTable",props:ee({columns:{},action:{type:Boolean,default:!0},height:{default:150}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(m){const t=te(m,"modelValue");let o=m;const{columns:s,action:e}=ae(o),d=M(()=>T("input")),g=M(()=>T("select")),V=M(()=>e.value?[...s.value,{title:"操作",dataIndex:"_action_"}]:s.value),N=i=>{var u;return((u=s.value.find(_=>_.dataIndex==i))==null?void 0:u.options)||[]},T=i=>s.value.filter(u=>u.type==i).map(u=>u.dataIndex),I=()=>{let i={};s.value.map(u=>{Reflect.set(i,u.dataIndex,"")}),t.value.push(i)},O=i=>{t.value.splice(i,1)};return(i,u)=>{const _=z,a=j,D=K,L=ne;return v(),F(L,{columns:V.value,"data-source":t.value,pagination:!1,rowKey:(c,p)=>p,size:"small",scroll:{y:i.height}},{bodyCell:r(({column:c,record:p,index:y})=>[d.value.includes(c.dataIndex)?(v(),F(_,{key:0,value:p[c.dataIndex],"onUpdate:value":x=>p[c.dataIndex]=x},null,8,["value","onUpdate:value"])):h("",!0),g.value.includes(c.dataIndex)?(v(),F(a,{key:1,value:p[c.dataIndex],"onUpdate:value":x=>p[c.dataIndex]=x,options:N(c.dataIndex)},null,8,["value","onUpdate:value","options"])):h("",!0),c.dataIndex=="_action_"?(v(),k("div",xe,[n($(E),{class:"icon",onClick:u[0]||(u[0]=x=>I())}),n($(oe),{class:"icon",onClick:x=>O(y)},null,8,["onClick"])])):h("",!0)]),emptyText:r(()=>[n(D,{type:"text",onClick:I,icon:P($(E))},{default:r(()=>[w(" 新增数据")]),_:1},8,["icon"])]),_:1},8,["columns","data-source","rowKey","scroll"])}}}),B=fe(we,[["__scopeId","data-v-5b9e8dbe"]]);class ye{constructor(t){b(this,"state",{});b(this,"InternalMapping",new Map);b(this,"rawData");b(this,"flowNodeList");this.rawData=t,this.flowNodeList=[],this.handleData(),this.InternalMapping=new Map([["func-node",this.executeFunction],["request-node",this.requestData],["link-node",this.onOpenLink],["modal-node",this.onOpenModal]])}handleData(){var o;const t=this.findFirstNode();return this.findLastNode(),(o=this.flowNodeList)==null||o.push(t),this.recPushNode(),this.flowNodeList}getFlowList(){return this.flowNodeList}recPushNode(){var o,s;const t=(o=this.flowNodeList)==null?void 0:o.at(-1);if(!this.isLast(t)){const e=this.findNextNode(t);return(s=this.flowNodeList)==null||s.push(e),this.recPushNode()}}findFirstNode(){if(!this.rawData)throw"The workflow has no data";const t=this.rawData.nodes.find(o=>this.isFirst(o));if(!t)throw"The workflow does not have a start node";return t}findNextNode(t){const o=this.rawData.edges.find(d=>d.sourceNodeId==t.id);if(!o)throw"The next edge was not found in the workflow data, please check the data!";const s=o.targetNodeId,e=this.rawData.nodes.find(d=>d.id==s);if(!e)throw"The next node was not found in the workflow data, please check the data!";return e}findLastNode(){var o;if(!((o=this.rawData)==null?void 0:o.nodes.some(s=>this.isLast(s))))throw"The workflow does not have a last node"}isFirst(t){return t.properties.nodeType=="start-node"}isLast(t){return t.properties.nodeType=="end-node"}onOpenModal(t){const{size:o,formId:s}=t.properties.extraData;this.state.modalFormData={};const e={small:"600px",middle:"1200px",large:"1800px"};return new Promise((d,g)=>{se.confirm({content:P(ve,{id:s,formData:this.state.modalFormData}),title:"表单",width:e[o],onCancel:()=>{g()},onOk:()=>{d(this.state.modalFormData)}})})}onOpenLink(t){const{url:o,openType:s}=t.properties.extraData;window.open(o,s)}async requestData(t){const s=await new Promise((e,d)=>{setTimeout(()=>{e(2e3)},1e3)});this.state.test=s}executeFunction(t){const{code:o}=t.properties.extraData,s=new Function(`return  ()=>{${o}}`),e=this;return s.call(e)()}async run(){var t;if(this.flowNodeList)for(let o=1;o<this.flowNodeList.length-1;o++){const s=this.flowNodeList[o],e=s.properties.nodeType;this.InternalMapping.get(e)&&await((t=this.InternalMapping.get(e))==null?void 0:t.call(this,s))}}}const Le=q({__name:"FlowView",setup(m){const t=f({nodes:[],edges:[]}),o=f([{type:"circle",text:"开始",label:"开始节点",icon:"/src/assets/images/flow/开始.png",properties:{nodeType:"start-node",extraData:{}}},{type:"circle",text:"结束",label:"结束节点",icon:"/src/assets/images/flow/结束.png",properties:{nodeType:"end-node",extraData:{}}},{type:"rect",text:"处理函数",label:"处理函数",icon:"/src/assets/images/flow/js函数.png",properties:{nodeType:"func-node",extraData:{code:""}}},{type:"rect",text:"打开弹窗",label:"弹窗",icon:"/src/assets/images/flow/弹窗.png",properties:{nodeType:"modal-node",extraData:{size:"small",formId:""}}},{type:"rect",text:"跳转外部链接",label:"链接",icon:"/src/assets/images/flow/链接.png",properties:{nodeType:"link-node",extraData:{url:"",openType:"_blank"}}},{type:"diamond",text:"请求数据",label:"请求数据",icon:"/src/assets/images/flow/发起请求.png",properties:{nodeType:"request-node",extraData:{url:"",method:"",params:[],headers:[],body:[]}}}]),s=f(!1),e=f({}),d=f(),g=f([]),V=f([{value:"get",label:"GET"},{value:"post",label:"POST"}]),N=f([{title:"Key",dataIndex:"key",type:"input"},{title:"Value",dataIndex:"value",type:"input"},{title:"引用变量",dataIndex:"var",type:"input"}]),T=f([{title:"Key",dataIndex:"key",type:"input"},{title:"Value",dataIndex:"value",type:"input"}]),I=()=>{d.value.getRawData()},O=_=>{s.value=!0,e.value=_.data};Z.getFormDict().then(_=>{const{code:a,data:D,msg:L}=_;a==200&&(g.value=D)});const i=()=>{d.value.updateNodeData(e.value)},u=()=>{const _=d.value.getRawData(),a=new ye(_);a.getFlowList(),a.run()};return(_,a)=>{const D=K,L=Q,c=Y,p=de,y=ue,x=ie,R=j,A=pe,S=z,U=ce,G=me,H=_e,J=le;return v(),k(C,null,[n(D,{onClick:a[0]||(a[0]=l=>I())},{default:r(()=>[w("保存")]),_:1}),n(D,{onClick:a[1]||(a[1]=l=>u())},{default:r(()=>[w("执行")]),_:1}),n(L,{ref_key:"eventFlowRef",ref:d,data:t.value,dndList:o.value,style:{height:"600px"},onOnClickEle:O},null,8,["data","dndList"]),n(J,{open:s.value,"onUpdate:open":a[12]||(a[12]=l=>s.value=l),title:"节点配置",placement:"right",onClose:a[13]||(a[13]=l=>i()),width:"600px"},{default:r(()=>[n(H,{model:e.value.properties.extraData},{default:r(()=>[e.value.properties.nodeType=="func-node"?(v(),F(p,{key:0,label:"函数"},{default:r(()=>[n(c,{value:e.value.properties.extraData.code,"onUpdate:value":a[2]||(a[2]=l=>e.value.properties.extraData.code=l),prepend:"()=>{",append:"}",theme:"light"},null,8,["value"])]),_:1})):h("",!0),e.value.properties.nodeType=="modal-node"?(v(),k(C,{key:1},[n(p,{label:"弹窗大小"},{default:r(()=>[n(x,{value:e.value.properties.extraData.size,"onUpdate:value":a[3]||(a[3]=l=>e.value.properties.extraData.size=l),"button-style":"solid"},{default:r(()=>[n(y,{value:"small"},{default:r(()=>[w("小")]),_:1}),n(y,{value:"middle"},{default:r(()=>[w("中")]),_:1}),n(y,{value:"large"},{default:r(()=>[w("大")]),_:1})]),_:1},8,["value"])]),_:1}),n(p,{label:"表单"},{default:r(()=>[n(R,{value:e.value.properties.extraData.formId,"onUpdate:value":a[4]||(a[4]=l=>e.value.properties.extraData.formId=l),options:g.value,fieldNames:{label:"name",value:"id"}},null,8,["value","options"])]),_:1})],64)):h("",!0),e.value.properties.nodeType=="link-node"?(v(),k(C,{key:2},[n(p,{label:"链接地址"},{default:r(()=>[n(A,{value:e.value.properties.extraData.url,"onUpdate:value":a[5]||(a[5]=l=>e.value.properties.extraData.url=l)},null,8,["value"])]),_:1}),n(p,{label:"打开方式"},{default:r(()=>[n(x,{value:e.value.properties.extraData.openType,"onUpdate:value":a[6]||(a[6]=l=>e.value.properties.extraData.openType=l),"button-style":"solid"},{default:r(()=>[n(y,{value:"_selef"},{default:r(()=>[w("当前页")]),_:1}),n(y,{value:"_blank"},{default:r(()=>[w("新窗口")]),_:1})]),_:1},8,["value"])]),_:1})],64)):h("",!0),e.value.properties.nodeType=="request-node"?(v(),k(C,{key:3},[n(S,{value:e.value.properties.extraData.url,"onUpdate:value":a[8]||(a[8]=l=>e.value.properties.extraData.url=l)},{addonBefore:r(()=>[n(R,{value:e.value.properties.extraData.method,"onUpdate:value":a[7]||(a[7]=l=>e.value.properties.extraData.method=l),options:V.value},null,8,["value","options"])]),_:1},8,["value"]),re("div",null,[n(G,null,{default:r(()=>[n(U,{key:"params",tab:"params"},{default:r(()=>[n(B,{columns:N.value,modelValue:e.value.properties.extraData.params,"onUpdate:modelValue":a[9]||(a[9]=l=>e.value.properties.extraData.params=l)},null,8,["columns","modelValue"])]),_:1}),n(U,{key:"headers",tab:"headers"},{default:r(()=>[n(B,{columns:T.value,modelValue:e.value.properties.extraData.headers,"onUpdate:modelValue":a[10]||(a[10]=l=>e.value.properties.extraData.headers=l)},null,8,["columns","modelValue"])]),_:1}),n(U,{key:"body",tab:"body"},{default:r(()=>[n(B,{columns:N.value,modelValue:e.value.properties.extraData.body,"onUpdate:modelValue":a[11]||(a[11]=l=>e.value.properties.extraData.body=l)},null,8,["columns","modelValue"])]),_:1})]),_:1})])],64)):h("",!0)]),_:1},8,["model"])]),_:1},8,["open"])],64)}}});export{Le as default};
