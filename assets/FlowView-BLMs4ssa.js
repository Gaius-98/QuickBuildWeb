var X=Object.defineProperty;var Y=(_,t,o)=>t in _?X(_,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):_[t]=o;var L=(_,t,o)=>(Y(_,typeof t!="symbol"?t+"":t,o),o);import{_ as Q}from"./CodeEditor.vue_vue_type_script_setup_true_name_EvCode_lang-BvEsA-0i.js";import{_ as Z}from"./EventFlow-CX9YvJUr.js";import{c as ee}from"./index-DOHWEVJc.js";import{g as P,t as te,x as ae,v as oe,D as O,o as x,h as $,w as l,V as w,y as g,l as n,i as B,bl as M,bm as ne,B as y,n as z,W as j,N as K,Y as S,a2 as se,R as le,r as v,F as b,H as re,J as ue,aS as de,X as ie,a3 as pe,a4 as ce,ai as me,a$ as _e,a_ as fe,$ as ve}from"./.pnpm-Cl1qeBT1.js";import{_ as xe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{_ as ye}from"./LowCodeFormId.vue_vue_type_script_setup_true_lang-Bqtro1QQ.js";import"./LowCodeForm.vue_vue_type_script_setup_true_lang-B6o74WEk.js";const we={key:2,style:{display:"flex"}},he=P({__name:"EditTable",props:te({columns:{},action:{type:Boolean,default:!0},height:{default:150}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(_){const t=ae(_,"modelValue");let o=_;const{columns:r,action:e}=oe(o),u=O(()=>N("input")),h=O(()=>N("select")),C=O(()=>e.value?[...r.value,{title:"操作",dataIndex:"_action_"}]:r.value),k=p=>{var d;return((d=r.value.find(f=>f.dataIndex==p))==null?void 0:d.options)||[]},N=p=>r.value.filter(d=>d.type==p).map(d=>d.dataIndex),T=()=>{let p={};r.value.map(d=>{Reflect.set(p,d.dataIndex,"")}),t.value.push(p)},F=p=>{t.value.splice(p,1)};return(p,d)=>{const f=j,a=K,D=S,I=se;return x(),$(I,{columns:C.value,"data-source":t.value,pagination:!1,rowKey:(c,i)=>i,size:"small",scroll:{y:p.height}},{bodyCell:l(({column:c,record:i,index:V})=>[u.value.includes(c.dataIndex)?(x(),$(f,{key:0,value:i[c.dataIndex],"onUpdate:value":m=>i[c.dataIndex]=m},null,8,["value","onUpdate:value"])):w("",!0),h.value.includes(c.dataIndex)?(x(),$(a,{key:1,value:i[c.dataIndex],"onUpdate:value":m=>i[c.dataIndex]=m,options:k(c.dataIndex)},null,8,["value","onUpdate:value","options"])):w("",!0),c.dataIndex=="_action_"?(x(),g("div",we,[n(B(M),{class:"icon",onClick:d[0]||(d[0]=m=>T())}),n(B(ne),{class:"icon",onClick:m=>F(V)},null,8,["onClick"])])):w("",!0)]),emptyText:l(()=>[n(D,{type:"text",onClick:T,icon:z(B(M))},{default:l(()=>[y(" 新增数据")]),_:1},8,["icon"])]),_:1},8,["columns","data-source","rowKey","scroll"])}}}),R=xe(he,[["__scopeId","data-v-5b9e8dbe"]]);class De{constructor(t){L(this,"state",{});L(this,"rawData");L(this,"flowNodeList");this.rawData=t,this.flowNodeList=[],this.handleData()}handleData(){var o;const t=this.findFirstNode();return this.findLastNode(),(o=this.flowNodeList)==null||o.push(t),this.recPushNode(),this.flowNodeList}getFlowList(){return this.flowNodeList}recPushNode(){var o,r;const t=(o=this.flowNodeList)==null?void 0:o.at(-1);if(!this.isLast(t)){const e=this.findNextNode(t);return(r=this.flowNodeList)==null||r.push(e),this.recPushNode()}}findFirstNode(){if(!this.rawData)throw"The workflow has no data";const t=this.rawData.nodes.find(o=>this.isFirst(o));if(!t)throw"The workflow does not have a start node";return t}findNextNode(t){const o=this.rawData.edges.find(u=>u.sourceNodeId==t.id);if(!o)throw"The next edge was not found in the workflow data,please check the data!";const r=o.targetNodeId,e=this.rawData.nodes.find(u=>u.id==r);if(!e)throw"The next node was not found in the workflow data,please check the data!";return e}findLastNode(){var o;if(!((o=this.rawData)==null?void 0:o.nodes.some(r=>this.isLast(r))))throw"The workflow does not have a last node"}isFirst(t){return t.properties.nodeType=="start-node"}isLast(t){return t.properties.nodeType=="end-node"}onOpenModal(t){const{size:o,formId:r}=t.properties.extraData;this.state.modalFormData={};const e={small:"600px",middle:"1200px",large:"1800px"};return new Promise((u,h)=>{le.confirm({content:z(ye,{id:r,formData:this.state.modalFormData}),title:"表单",width:e[o],onCancel:()=>{h()},onOk:()=>{u(this.state.modalFormData)}})})}onOpenLink(t){const{url:o,openType:r}=t.properties.extraData;window.open(o,r)}async requestData(t){const r=await new Promise((e,u)=>{setTimeout(()=>{e(2e3)},1e3)});this.state.test=r}executeFunction(t){const{code:o,async:r}=t.properties.extraData,e=new Function(`return ()=>{${o}}`),u=this;e.call(u)()}async run(){if(this.flowNodeList)for(let t=1;t<this.flowNodeList.length-1;t++){const o=this.flowNodeList[t];switch(o.properties.nodeType){case"func-node":await this.executeFunction(o);break;case"request-node":await this.requestData(o);break;case"link-node":this.onOpenLink(o);break;case"modal-node":await this.onOpenModal(o);break}}}}const Fe=P({__name:"FlowView",setup(_){const t=v({nodes:[],edges:[]}),o=v([{type:"circle",text:"开始",label:"开始节点",icon:"/src/assets/images/flow/开始.png",properties:{nodeType:"start-node",extraData:{}}},{type:"circle",text:"结束",label:"结束节点",icon:"/src/assets/images/flow/结束.png",properties:{nodeType:"end-node",extraData:{}}},{type:"rect",text:"处理函数",label:"处理函数",icon:"/src/assets/images/flow/js函数.png",properties:{nodeType:"func-node",extraData:{code:"",async:!1}}},{type:"rect",text:"打开弹窗",label:"弹窗",icon:"/src/assets/images/flow/弹窗.png",properties:{nodeType:"modal-node",extraData:{size:"small",formId:""}}},{type:"rect",text:"跳转外部链接",label:"链接",icon:"/src/assets/images/flow/链接.png",properties:{nodeType:"link-node",extraData:{url:"",openType:"_blank"}}},{type:"diamond",text:"请求数据",label:"请求数据",icon:"/src/assets/images/flow/发起请求.png",properties:{nodeType:"request-node",extraData:{url:"",method:"",params:[],headers:[],body:[]}}}]),r=v(!1),e=v({}),u=v(),h=v([]),C=v([{value:"get",label:"GET"},{value:"post",label:"POST"}]),k=v([{title:"Key",dataIndex:"key",type:"input"},{title:"Value",dataIndex:"value",type:"input"},{title:"引用变量",dataIndex:"var",type:"input"}]),N=v([{title:"Key",dataIndex:"key",type:"input"},{title:"Value",dataIndex:"value",type:"input"}]),T=()=>{u.value.getRawData()},F=f=>{r.value=!0,e.value=f.data};ee.getFormDict().then(f=>{const{code:a,data:D,msg:I}=f;a==200&&(h.value=D)});const p=()=>{u.value.updateNodeData(e.value)},d=()=>{const f=u.value.getRawData(),a=new De(f);a.getFlowList(),a.run()};return(f,a)=>{const D=S,I=Z,c=de,i=ie,V=Q,m=pe,E=ce,q=K,A=me,G=j,U=_e,H=fe,J=ve,W=re;return x(),g(b,null,[n(D,{onClick:a[0]||(a[0]=s=>T())},{default:l(()=>[y("保存")]),_:1}),n(D,{onClick:a[1]||(a[1]=s=>d())},{default:l(()=>[y("执行")]),_:1}),n(I,{ref_key:"eventFlowRef",ref:u,data:t.value,dndList:o.value,style:{height:"600px"},onOnClickEle:F},null,8,["data","dndList"]),n(W,{open:r.value,"onUpdate:open":a[13]||(a[13]=s=>r.value=s),title:"节点配置",placement:"right",onClose:a[14]||(a[14]=s=>p()),width:"600px"},{default:l(()=>[n(J,{model:e.value.properties.extraData},{default:l(()=>[e.value.properties.nodeType=="func-node"?(x(),g(b,{key:0},[n(i,{label:"是否异步"},{default:l(()=>[n(c,{value:e.value.properties.extraData.async,"onUpdate:value":a[2]||(a[2]=s=>e.value.properties.extraData.async=s)},null,8,["value"])]),_:1}),n(i,{label:"函数"},{default:l(()=>[n(V,{value:e.value.properties.extraData.code,"onUpdate:value":a[3]||(a[3]=s=>e.value.properties.extraData.code=s),prepend:e.value.properties.extraData.async?"async ()=>{":"()=>{",append:"}",theme:"light"},null,8,["value","prepend"])]),_:1})],64)):w("",!0),e.value.properties.nodeType=="modal-node"?(x(),g(b,{key:1},[n(i,{label:"弹窗大小"},{default:l(()=>[n(E,{value:e.value.properties.extraData.size,"onUpdate:value":a[4]||(a[4]=s=>e.value.properties.extraData.size=s),"button-style":"solid"},{default:l(()=>[n(m,{value:"small"},{default:l(()=>[y("小")]),_:1}),n(m,{value:"middle"},{default:l(()=>[y("中")]),_:1}),n(m,{value:"large"},{default:l(()=>[y("大")]),_:1})]),_:1},8,["value"])]),_:1}),n(i,{label:"表单"},{default:l(()=>[n(q,{value:e.value.properties.extraData.formId,"onUpdate:value":a[5]||(a[5]=s=>e.value.properties.extraData.formId=s),options:h.value,fieldNames:{label:"name",value:"id"}},null,8,["value","options"])]),_:1})],64)):w("",!0),e.value.properties.nodeType=="link-node"?(x(),g(b,{key:2},[n(i,{label:"链接地址"},{default:l(()=>[n(A,{value:e.value.properties.extraData.url,"onUpdate:value":a[6]||(a[6]=s=>e.value.properties.extraData.url=s)},null,8,["value"])]),_:1}),n(i,{label:"打开方式"},{default:l(()=>[n(E,{value:e.value.properties.extraData.openType,"onUpdate:value":a[7]||(a[7]=s=>e.value.properties.extraData.openType=s),"button-style":"solid"},{default:l(()=>[n(m,{value:"_selef"},{default:l(()=>[y("当前页")]),_:1}),n(m,{value:"_blank"},{default:l(()=>[y("新窗口")]),_:1})]),_:1},8,["value"])]),_:1})],64)):w("",!0),e.value.properties.nodeType=="request-node"?(x(),g(b,{key:3},[n(G,{value:e.value.properties.extraData.url,"onUpdate:value":a[9]||(a[9]=s=>e.value.properties.extraData.url=s)},{addonBefore:l(()=>[n(q,{value:e.value.properties.extraData.method,"onUpdate:value":a[8]||(a[8]=s=>e.value.properties.extraData.method=s),options:C.value},null,8,["value","options"])]),_:1},8,["value"]),ue("div",null,[n(H,null,{default:l(()=>[n(U,{key:"params",tab:"params"},{default:l(()=>[n(R,{columns:k.value,modelValue:e.value.properties.extraData.params,"onUpdate:modelValue":a[10]||(a[10]=s=>e.value.properties.extraData.params=s)},null,8,["columns","modelValue"])]),_:1}),n(U,{key:"headers",tab:"headers"},{default:l(()=>[n(R,{columns:N.value,modelValue:e.value.properties.extraData.headers,"onUpdate:modelValue":a[11]||(a[11]=s=>e.value.properties.extraData.headers=s)},null,8,["columns","modelValue"])]),_:1}),n(U,{key:"body",tab:"body"},{default:l(()=>[n(R,{columns:k.value,modelValue:e.value.properties.extraData.body,"onUpdate:modelValue":a[12]||(a[12]=s=>e.value.properties.extraData.body=s)},null,8,["columns","modelValue"])]),_:1})]),_:1})])],64)):w("",!0)]),_:1},8,["model"])]),_:1},8,["open"])],64)}}});export{Fe as default};
