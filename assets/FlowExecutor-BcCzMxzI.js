var d=Object.defineProperty;var h=(n,t,e)=>t in n?d(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var r=(n,t,e)=>(h(n,typeof t!="symbol"?t+"":t,e),e);import{_ as l}from"./LowCodeFormId.vue_vue_type_script_setup_true_lang-Cn_lhMlM.js";import{a0 as c,n as f}from"./.pnpm-C57POoKK.js";class N{constructor(t){r(this,"state",{});r(this,"InternalMapping",new Map);r(this,"rawData");r(this,"flowNodeList");this.rawData=t,this.flowNodeList=[],this.handleData(),this.InternalMapping=new Map([["func-node",this.executeFunction],["request-node",this.requestData],["link-node",this.onOpenLink],["modal-node",this.onOpenModal]])}handleData(){var e;const t=this.findFirstNode();return this.findLastNode(),(e=this.flowNodeList)==null||e.push(t),this.recPushNode(),this.flowNodeList}getFlowList(){return this.flowNodeList}getState(){return this.state}recPushNode(){var e,s;const t=(e=this.flowNodeList)==null?void 0:e.at(-1);if(!this.isLast(t)){const o=this.findNextNode(t);return(s=this.flowNodeList)==null||s.push(o),this.recPushNode()}}findFirstNode(){if(!this.rawData)throw"The workflow has no data";const t=this.rawData.nodes.find(e=>this.isFirst(e));if(!t)throw"The workflow does not have a start node";return t}findNextNode(t){const e=this.rawData.edges.find(a=>a.sourceNodeId==t.id);if(!e)throw"The next edge was not found in the workflow data, please check the data!";const s=e.targetNodeId,o=this.rawData.nodes.find(a=>a.id==s);if(!o)throw"The next node was not found in the workflow data, please check the data!";return o}findLastNode(){var e;if(!((e=this.rawData)==null?void 0:e.nodes.some(s=>this.isLast(s))))throw"The workflow does not have a last node"}isFirst(t){return t.properties.nodeType=="start-node"}isLast(t){return t.properties.nodeType=="end-node"}onOpenModal(t){const{size:e,formId:s}=t.properties.extraData;this.state.modalFormData={};const o={small:"600px",middle:"1200px",large:"1800px"};return new Promise((a,i)=>{c.confirm({content:f(l,{id:s,formData:this.state.modalFormData}),title:"表单",width:o[e],onCancel:()=>{i()},onOk:()=>{a(this.state.modalFormData)}})})}onOpenLink(t){const{url:e,openType:s}=t.properties.extraData;window.open(e,s)}async requestData(t){const s=await new Promise((o,a)=>{setTimeout(()=>{o(2e3)},1e3)});this.state.test=s}executeFunction(t){const{code:e}=t.properties.extraData,s=new Function(`return  ()=>{${e}}`),o=this;return s.call(o)()}async run(){var t;if(this.flowNodeList)try{for(let e=1;e<this.flowNodeList.length-1;e++){const s=this.flowNodeList[e],o=s.properties.nodeType;this.InternalMapping.get(o)&&await((t=this.InternalMapping.get(o))==null?void 0:t.call(this,s))}}catch(e){return e}}}export{N as F};
