var h=Object.defineProperty;var l=(a,t,e)=>t in a?h(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var n=(a,t,e)=>(l(a,typeof t!="symbol"?t+"":t,e),e);import{bV as i,h as c,c as u}from"./iconfont-DlnTACa0.js";import{_ as p}from"./LowCodeFormId.vue_vue_type_script_setup_true_lang-DnljEEER.js";import{M as f}from"./index-rRoPRs5X.js";const g={getList:a=>i({method:"get",url:"table/list",params:a}),getDetail:a=>i({method:"get",url:"table/detail",params:{id:a}}),remove:a=>i({method:"get",url:"table/remove",params:{id:a}}),add:a=>i({method:"post",url:"table/add",data:a}),update:a=>i({method:"post",url:"table/update",data:a})};class L{constructor(t){n(this,"state",{});n(this,"InternalMapping",new Map);n(this,"rawData");n(this,"flowNodeList");this.rawData=t,this.flowNodeList=[],this.handleData(),this.InternalMapping=new Map([["func-node",this.executeFunction],["request-node",this.requestData],["link-node",this.onOpenLink],["modal-node",this.onOpenModal]])}setModalFormData(t){this.state.modalFormData=t}handleData(){var e;const t=this.findFirstNode();return this.findLastNode(),(e=this.flowNodeList)==null||e.push(t),this.recPushNode(),this.flowNodeList}getFlowList(){return this.flowNodeList}getState(){return this.state}recPushNode(){var e,o;const t=(e=this.flowNodeList)==null?void 0:e.at(-1);if(!this.isLast(t)){const s=this.findNextNode(t);return(o=this.flowNodeList)==null||o.push(s),this.recPushNode()}}findFirstNode(){if(!this.rawData)throw"The workflow has no data";const t=this.rawData.nodes.find(e=>this.isFirst(e));if(!t)throw"The workflow does not have a start node";return t}findNextNode(t){const e=this.rawData.edges.find(r=>r.sourceNodeId==t.id);if(!e)throw"The next edge was not found in the workflow data, please check the data!";const o=e.targetNodeId,s=this.rawData.nodes.find(r=>r.id==o);if(!s)throw"The next node was not found in the workflow data, please check the data!";return s}findLastNode(){var e;if(!((e=this.rawData)==null?void 0:e.nodes.some(o=>this.isLast(o))))throw"The workflow does not have a last node"}isFirst(t){return t.properties.nodeType=="start-node"}isLast(t){return t.properties.nodeType=="end-node"}onOpenModal(t){const{size:e,formId:o}=t.properties.extraData;this.state.modalFormData=this.state.modalFormData?this.state.modalFormData:{};const s={small:"600px",middle:"1200px",large:"1800px"};return new Promise((r,d)=>{f.confirm({content:c(p,{id:o,formData:this.state.modalFormData}),icon:null,title:"表单",width:s[e],onCancel:()=>{d()},onOk:()=>{r(this.state.modalFormData)}})})}onOpenLink(t){const{url:e,openType:o}=t.properties.extraData;window.open(e,o)}async requestData(t){const e=new Promise((s,r)=>{u.getProxyData({...t.properties.extraData,state:this.state}).then(d=>{s(d.data)})});let o;try{o=await e}catch(s){console.error(s)}this.state.requestData=o}executeFunction(t){const{code:e}=t.properties.extraData,o=new Function(`return  ()=>{${e}}`),s=this;try{return o.call(s)()}catch(r){console.error(r)}}async run(){var t;if(this.flowNodeList)try{for(let e=1;e<this.flowNodeList.length-1;e++){const o=this.flowNodeList[e],s=o.properties.nodeType;this.InternalMapping.get(s)&&await((t=this.InternalMapping.get(s))==null?void 0:t.call(this,o))}}catch(e){return e}}}export{L as F,g as a};
